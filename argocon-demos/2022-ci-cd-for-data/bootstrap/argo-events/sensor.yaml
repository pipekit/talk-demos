apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github
spec:
  dependencies:
    - name: test-dep
      eventSourceName: github
      eventName: example
      filters:
        data:
          - path: body.action
            type: string
            value:
              - opened
              - edited
              - reopened
              - synchronize
          - path: body.pull_request.state
            type: string
            value:
              - open
          - path: body.pull_request.base.ref
            type: string
            value:
              - main
  triggers:
    - template:
        name: github-workflow-trigger
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                name: github-doubler-test-
              spec:
                entrypoint: assert-doubler
                templates:
                  - name: run-doubler-and-assert
                    inputs:
                      parameters:
                        - name: input
                        - name: expected
                    steps:
                    - - name: run-doubler
                        templateRef:
                          name: doubler
                          template: double
                        arguments:
                          parameters:
                            - name: input
                              value: "{{inputs.parameters.input}}"
                    - - name: assert
                        template: assert-equal
                        arguments:
                          parameters:
                            - name: input
                              value: "{{inputs.parameters.input}}"
                            - name: actual
                              value: "{{steps.run-doubler.outputs.result}}"
                            - name: expected
                              value: "{{inputs.parameters.expected}}"

                  - name: assert-equal
                    inputs:
                      parameters:
                      - name: input
                      - name: actual
                      - name: expected
                    script:
                      image: python:alpine3.6
                      command: [python]
                      source: |
                        assert {{inputs.parameters.actual}} == {{inputs.parameters.expected}}, f"for {{inputs.parameters.input}}, expected {{inputs.parameters.expected}}, got {{inputs.parameters.actual}}"

                  - name: assert-doubler
                    steps:
                    - - name: run-doubler-and-assert
                        template: run-doubler-and-assert
                        arguments:
                          parameters:
                          - name: input
                            value: "{{item.input}}"
                          - name: expected
                            value: "{{item.expected}}"
                        withItems:
                          - { input: '2', expected: '4' }
                          - { input: '4', expected: '8' }
                          - { input: '0', expected: '0' }

          parameters:
            - src:
                dependencyName: test-dep
                dataKey: body.pull_request.title
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: test-dep
                dataKey: body.pull_request.number
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: test-dep
                dataTemplate: "{{ .Input.body.pull_request.head.sha | substr 0 7 }}"
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: test-dep
                dataTemplate: "{{ .Input.body.pull_request.number }}-{{ .Input.body.pull_request.head.sha | substr 0 7 }}"
              dest: metadata.name
              operation: append
      retryStrategy:
        steps: 3
